name: build

on:
  workflow_call:
    inputs:
      updateKustomize:
        description: "Update kustomize overlays"
        type: boolean
        required: false
      skipTests:
        description: "Skip extended testing (unit and other tests), only build artifacts"
        type: boolean
        required: false
        default: false
      kustomizeOverlays:
        description: "Overlays to update"
        type: string
        required: false
      environments:
        type: string
        required: true
      git-hosting:
        type: string
        required: true
      modules:
        type: string
        required: true
      modules-string:
        type: string
        required: true
      kustomize-repository:
        type: string
        required: true
      profile:
        type: string
        required: true

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
      - id: init
        name: Init Job
        uses: hawk-ai-aml/github-actions/job-init@python-ai-scores

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - name: Install pipenv
        run: pip install pipenv

      - name: Run Pytest
        env:
          JENKINS: true
          IS_JENKINS: true
          AWS_ACCESS_KEY_ID: ${{ secrets.BACKEND_FILE_AWS_ACCESS_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.BACKEND_FILE_AWS_SECRET_ACCESS_KEY }}
        run: |
          pipenv install --dev
          pipenv requirements --dev > requirements.txt
          pipenv run pip install -r manual-requirements.txt
      #          pipenv run pytest tests --junitxml=report.xml
      #          pipenv run junit2html report.xml report.html
      #          mkdir report-dir && mv report.html ./report-dir/report.html

      #      - name: Upload Reports to S3
      #        id: reports
      #        if: needs.init.outputs.skip-tests != 'true' && (success() || failure())
      #        uses: hawk-ai-aml/upload-s3-action@master
      #        with:
      #          aws_key_id: ${{ secrets.AWS_DEV_ACCESS_KEY_ID }}
      #          aws_secret_access_key: ${{ secrets.AWS_DEV_SECRET_ACCESS_KEY }}
      #          aws_bucket: github-actions-static-html-2
      #          source_dir: ./report-dir
      #          destination_dir: ${{ github.event.repository.name }}-${{ github.run_id }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ inputs.profile == 'nab' && secrets.AWS_NAB_DEV_ECR_ACCESS_KEY_ID || secrets.AWS_ORG_ECR_ACCESS_KEY_ID }}
          aws-region: ${{ inputs.profile == 'nab' && 'us-east-1' || secrets.AWS_ORG_ECR_SECRET_ACCESS_KEY && 'eu-central-1' }}
          aws-secret-access-key: ${{ inputs.profile == 'nab' && secrets.AWS_NAB_DEV_ECR_SECRET_ACCESS_KEY || secrets.AWS_ORG_ECR_SECRET_ACCESS_KEY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        with:
          registries: ${{ inputs.profile == 'nab' && 569345997196 || 860641649575 }}

      - name: Build and tag images
        env:
          MODULES: ${{ inputs.modules-string }}
          REGISTRY: ${{ inputs.profile == 'nab' && '569345997196.dkr.ecr.us-east-1.amazonaws.com' || '860641649575.dkr.ecr.eu-central-1.amazonaws.com' }}
        run: |
          echo $MODULES
          for module in $MODULES
          do
            REPOSITORY_FOLDER=$(echo ${module} | sed 's/\_/\-/g')
            REPOSITORY_FULL_NAME="$REGISTRY/ai-scores-${REPOSITORY_FOLDER}"
            echo "$REPOSITORY_FULL_NAME is building..."
            DOCKER_BUILDKIT=1 docker build --build-arg SERVICE=${module} -t ${REPOSITORY_FULL_NAME}:$${{ github.ref_name }} .
            docker push ${REPOSITORY_FULL_NAME}:$${{ github.ref_name }}
          done

  update-overlays:
    needs: build
    if: ${{ needs.init.outputs.update-kustomize == 'true' }}
    runs-on: [ "self-hosted", "builder" ]
    strategy:
      # Avoid race condition issues with github
      max-parallel: 2
      matrix:
        overlay: ${{fromJson(inputs.environments)}}
        module: ${{fromJson(inputs.modules)}}

    steps:
      - name: Checkout Kustomize (GitHub)
        if: ${{ inputs.git-hosting  == 'github' }}
        uses: actions/checkout@v3
        with:
          repository: hawk-ai-aml/kustomize2.git
          token: ${{ secrets.TEST_TOKEN }}
          ref: master

      - name: Update Kustomize (GitHub)
        if: ${{ inputs.git-hosting  == 'github' }}
        run: |
          cd ${{ github.workspace }}/plattform/processing/features/${{ matrix.module }}/overlays/${{ matrix.overlay }}
          REPOSITORY_FOLDER=$(echo ${{ matrix.service }} | sed 's/\_/\-/g')
          REPOSITORY_FULL_NAME="${ECR_REGISTRY}/ai-scores-${REPOSITORY_FOLDER}"
          # kustomize edit set image $REPOSITORY_FULL_NAME:${{ env.HAWK_IMAGE_TAG }}
          kustomize edit set image $REPOSITORY_FULL_NAME:${{ github.ref_name }}
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@hawk.ai"
          git add .
          git commit -m "Change Tag"
          git push

      - name: Update Kustomize (Bitbucket)
        if: ${{ inputs.git-hosting  == 'bitbucket' }}
        shell: bash
        env:
          HAWK_IMAGE_NAME: ai-scores-${{ matrix.module }}
          NAB_IMAGE_NAME: hawk-ai-scores-${{ matrix.module }}
          KUSTOMIZE_SSH_KEY_FILE: /home/builder/.ssh/id_kustomize_private_key
          KUSTOMIZE_SSH_KEY: ${{ secrets.KUSTOMIZE_DEPLOY_PRIVATE_KEY }}
          KUSTOMIZE_PATH: /plattform/processing/features/
          OVERLAY: ${{ matrix.overlay }}
        run: |
          # Prepare SSH
          mkdir -p $(dirname ${KUSTOMIZE_SSH_KEY_FILE})
          echo ${KUSTOMIZE_SSH_KEY} | base64 -d > ${KUSTOMIZE_SSH_KEY_FILE}
          chmod 600 ${KUSTOMIZE_SSH_KEY_FILE}
          export GIT_SSH_COMMAND="ssh -i ${KUSTOMIZE_SSH_KEY_FILE}"
          cat <<EOF >> ~/.ssh/known_hosts
          bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAubiN81eDcafrgMeLzaFPsw2kNvEcqTKl/VqLat/MaB33pZy0y3rJZtnqwR2qOOvbwKZYKiEO1O6VqNEBxKvJJelCq0dTXWT5pbO2gDXC6h6QDXCaHo6pOHGPUy+YBaGQRGuSusMEASYiWunYN0vCAI8QaXnWMXNMdFP3jHAJH0eDsoiGnLPBlBp4TNm6rYI74nMzgz3B9IikW4WVK+dc8KZJZWYjAuORU3jc1c/NPskD2ASinf8v3xnfXeukU0sJ5N6m5E8VLjObPEO+mN2t/FZTMZLiFqPWc/ALSqnMnnhwrNi2rbfg/rd/IpL8Le3pSBne8+seeFVBoGqzHM9yXw==
          EOF
          # End prepare SSH
          git clone ${{ inputs.kustomize-repo }} kustomize
          cd kustomize/${KUSTOMIZE_PATH}/overlays/${OVERLAY}
          # https://hawkai.atlassian.net/browse/SRE-629
          # this relies that all nab overlays are called nab-dev
          # nicer way is to pass profile, than evaluating overlay
          if [[ ${OVERLAY} == 'nab-dev' ]]; then
          kustomize edit set image ${HAWK_IMAGE_NAME}=${NAB_IMAGE_NAME}:${{ inputs.component-tag }}
          else
          kustomize edit set image ${HAWK_IMAGE_NAME}:${{ inputs.component-tag }}
          fi
          if ! git diff --quiet HEAD; then
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@hawk.ai"
          git add .
          git commit -m "AUTOMATIC COMMIT: Update ${KUSTOMIZE_PATH}/overlays/${OVERLAY} for ${{ inputs.component-name }} to ${{ env.HAWK_IMAGE_TAG }}"
          git push
          fi

#      - id: udpate-overlay-github
#        name: Update kustomize overlay (GitHub)
#        if: fromJson(needs.init.outputs.parameters).kustomize == 'github' || fromJson(needs.init.outputs.parameters).kustomize == 'github-fake'
#        uses: hawk-ai-aml/github-actions/kustomize-overlay@python-ai-scores
#        with:
#          component-name: ${{ inputs.component }}
#         #  component-metadata: ${{ needs.init.outputs.metadata }}
#          component-overlay: ${{ matrix.overlay }}
#          component-tag: ${{ env.HAWK_IMAGE_TAG }}
#          kustomize-repo: ${{ fromJson(needs.init.outputs.parameters).kustomize == 'github-fake' && 'hawk-ai-aml/kustomize2.git' || 'hawk-ai-aml/kustomize.git' }}
#          kustomize-access-token: ${{ secrets.REPO_ACCESS_PAT }}
#
#      - id: udpate-overlay-bitbucket
#        name: Update kustomize overlay (Bitbucket)
#        if: fromJson(needs.init.outputs.parameters).kustomize == 'bitbucket' || fromJson(needs.init.outputs.parameters).kustomize == 'bitbucket-fake'
#        uses: hawk-ai-aml/github-actions/kustomize-overlay-ssh@python-ai-scores
#        with:
#          component-name: ${{ inputs.component }}
#          # component-metadata: ${{ needs.init.outputs.metadata }}
#          component-overlay: ${{ matrix.overlay }}
#          component-tag: ${{ env.HAWK_IMAGE_TAG }}
#          kustomize-repo: ${{ fromJson(needs.init.outputs.parameters).kustomize == 'bitbucket-fake' && 'git@bitbucket.org:hawkai/kustomize2.git' || 'git@bitbucket.org:hawkai/kustomize.git' }}
#          kustomize-ssh-key: ${{ secrets.KUSTOMIZE_DEPLOY_PRIVATE_KEY }}
