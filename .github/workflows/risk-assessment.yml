name: Risk Assessment

on:
  workflow_call:
    inputs:
      sra-enabled:
        description: 'Enable or disable the entire risk assessment workflow'
        required: false
        type: boolean
        default: true
      enforce-mode:
        description: 'Whether to enforce risk assessment results'
        required: false
        type: boolean
        default: false
      github-actions-ref:
        description: 'Branch/ref to use for hawk-ai-aml/github-actions repository'
        required: false
        type: string
        default: 'master'
    secrets:
      github-token:
        description: 'GitHub token with appropriate permissions'
        required: true
    outputs:
      risk-score:
        description: 'Calculated risk score'
        value: ${{ jobs.risk-assessment.outputs.risk-score }}
      risk-tier:
        description: 'Risk tier'
        value: ${{ jobs.risk-assessment.outputs.risk-tier }}
      status:
        description: 'Assessment status'
        value: ${{ jobs.risk-assessment.outputs.status }}

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  models: read

jobs:
  risk-assessment:
    runs-on: [ self-hosted, small-builder ]
    name: Calculate Risk Score
    if: ${{ inputs.sra-enabled && !github.event.pull_request.draft }}
    outputs:
      risk-score: ${{ steps.sra.outputs.risk-score }}
      risk-tier: ${{ steps.sra.outputs.risk-tier }}
      status: ${{ steps.sra.outputs.status }}
      fallback: ${{ steps.sra.outputs.fallback }}

    env:
      SRA_ENFORCE_MODE: ${{ inputs.enforce-mode }}

    steps:

      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout github actions
        uses: actions/checkout@v4
        with:
          repository: hawk-ai-aml/github-actions
          path: .github-actions
          ref: ${{ inputs.github-actions-ref }}
          token: ${{ secrets.github-token }}

      - name: Send workflow start metric
        id: metrics-start
        continue-on-error: true
        uses: ./.github-actions/workflow-metrics
        with:
          action: start
          grouping-keys: |
            job: github_risk_assessment
            repository: ${{ github.repository }}
            ref: ${{ github.ref }}
          labels: |
            github_actions_ref: ${{ inputs.github-actions-ref }}
            sra_enabled: ${{ inputs.sra-enabled }}
            enforce_mode: ${{ inputs.enforce-mode }}

      - name: Load Risk Questions Config
        id: load-config
        run: |
          CONFIG_PATH=".github-actions/risk-assessment/config/risk-questions.json"

          # Read and encode config as base64
          CONFIG_B64=$(cat "$CONFIG_PATH" | base64 -w 0)
          echo "config-b64=$CONFIG_B64" >> $GITHUB_OUTPUT

      - name: Run Risk Assessment
        id: sra
        uses: ./.github-actions/risk-assessment
        with:
          github-token: ${{ secrets.github-token }}
          config: ${{ steps.load-config.outputs.config-b64 }}

      - name: Send workflow completion metric
        id: metrics-complete
        if: always()
        continue-on-error: true
        uses: ./.github-actions/workflow-metrics
        with:
          action: complete
          grouping-keys: |
            job: github_risk_assessment
            repository: ${{ github.repository }}
            ref: ${{ github.ref }}
            fallback: ${{ steps.sra.outputs.fallback }}
          labels: |
            github_actions_ref: ${{ inputs.github-actions-ref }}
            sra_enabled: ${{ inputs.sra-enabled }}
            enforce_mode: ${{ inputs.enforce-mode }}
            tier: ${{ steps.sra.outputs.risk-tier || 'unknown' }}
            status: ${{ job.status || 'unknown' }}
          additional-metrics: |
            github_risk_assessment_score: ${{ steps.sra.outputs.risk-score || '-1' }}
          start-time: ${{ steps.metrics-start.outputs.start-time }}
