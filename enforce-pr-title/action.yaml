name: enforce-pr-title
description: Enforce pull request title includes Jira Issue key

inputs:
  repository-ref:
    description: "Repository ref"
    required: false
    default: master

  repository-access-token:
    description: "Repository access token"
    required: true

  jira-account-name:
    description: "Jira login name"
    required: true

  jira-token:
    description: "Jira access token generated by configured account above"
    required: true

runs:
  using: composite
  steps:

    - name: Validate PR title
      shell: bash -l -ET -eo pipefail {0}
      env:
        GITHUB_TOKEN: ${{ inputs.repository-access-token }}
        GITHUB_REF: ${{ inputs.repository-ref }}
        JIRA_USER: ${{ inputs.jira-account-name }}
        JIRA_TOKEN: ${{ inputs.jira-token }}
      run: |
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        
        PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
        
        PR_TITLE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER" | jq -r '.title')
        
        if [[ !("$PR_TITLE" =~ ^([A-Z]){3}-{1}([0-9])*:{1}.*$) ]]; then
          echo -e "${RED}The PR title is invalid."
          echo -e "${GREEN}The correct format is: {1}-{2}:{3}"
          echo -e "${GREEN}SAMPLE"
          echo -e "${GREEN}SRE-1234: I like to drink coffee every day!"
          echo -e "${GREEN}{1}-{2} is your Jira ticket number (All characters must be in UPPERCASE)"
          echo -e "${GREEN}{3} is your PR message"
          exit 1
        fi
        
        JIRA_NUMBER=$(echo "$PR_TITLE" | grep -oP "([A-Z]){3}-{1}([0-9])*")
        echo "Jira ticket number: $JIRA_NUMBER"
        ANY_ERROR=$(curl -s "https://hawkai.atlassian.net/rest/api/3/issue/$JIRA_NUMBER" -u $JIRA_USER:$JIRA_TOKEN | jq -r '.errorMessages')
        
        if [[ $ANY_ERROR != null ]]; then
          echo -e "${RED}Cannot find Jira ticket with information from PR header. Please correct it"
          exit 1
        fi
        
        echo -e "${GREEN}The PR title is valid"
# End of file
