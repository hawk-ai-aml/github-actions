name: kustomize-overlay-ssh-multi
description: Kustomize Overlay in BitBucket

inputs:
  component-name:
    description: "Component name"
    required: true

  component-modules:
    description: "Component modules to update (JSON)"
    required: false
    default: ""

  component-overlays:
    description: "Overlays to update (list, JSON)"
    required: true
  
  component-tag:
    description: "New component tag"
    required: true

  kustomize-repo:
    description: kustomize repository
    required: true

  kustomize-ssh-key:
    description: kustomize RW access SSH key
    required: true

runs:
  using: composite
  steps:
    - name: Update kustomize Overlay
      shell: bash -l -eo pipefail {0}
      env:
        KUSTOMIZE_SSH_KEY_FILE: /home/builder/.ssh/id_kustomize_private_key
        KUSTOMIZE_SSH_KEY: ${{ inputs.kustomize-ssh-key }}
        OVERLAY: ${{ inputs.component-overlay }}
      run: |
        # Prepare SSH key for kustomize
        mkdir -p $(dirname ${KUSTOMIZE_SSH_KEY_FILE})
        echo ${KUSTOMIZE_SSH_KEY} | base64 -d > ${KUSTOMIZE_SSH_KEY_FILE}
        chmod 600 ${KUSTOMIZE_SSH_KEY_FILE}
        export GIT_SSH_COMMAND="ssh -i ${KUSTOMIZE_SSH_KEY_FILE}"

        # Clone and setup git
        git clone ${{ inputs.kustomize-repo }} kustomize

        for module in ${{ inputs.component-modules }}; do
          for overlay in ${{ inputs.component-overlays }}; do
            HAWK_IMAGE_NAME=$(hawk.get-component-image ${{ inputs.component-name }} hawk )
            NAB_IMAGE_NAME=$(hawk.get-component-image ${{ inputs.component-name }} nab ${{ inputs.component-module }})
            KUSTOMIZE_PATH=$(hawk.get-component-kustomize-path ${{ inputs.component-name }} hawk ${{ inputs.component-module }})
            
            (
              cd kustomize/${KUSTOMIZE_PATH}/overlays/${overlay}

              # https://hawkai.atlassian.net/browse/SRE-629
              # this relies that all nab overlays are called nab-dev
              # nicer way is to pass profile, than evaluating overlay
              if [[ ${overlay} == 'nab-dev' ]]; then
                kustomize edit set image ${HAWK_IMAGE_NAME}=${NAB_IMAGE_NAME}:${{ inputs.component-tag }}
              else
                kustomize edit set image ${HAWK_IMAGE_NAME}:${{ inputs.component-tag }}
              fi

              git commit -m "AUTOMATIC COMMIT: Update ${KUSTOMIZE_PATH}/overlays/${overlay} for ${{ inputs.component-name }} to ${{ inputs.component-tag }}"
            )
          done
        done

        if ! git diff --quiet HEAD; then
          git push
        fi
