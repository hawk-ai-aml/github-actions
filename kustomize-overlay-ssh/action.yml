name: kustomize-overlay-ssh
description: Kustomize Overlay in BitBucket

inputs:
  component-name:
    description: "Component name"
    required: true

  component-metadata:
    description: "Component metadata"
    required: true

  component-overlay:
    description: "Overlay to update"
    required: true
  
  component-tag:
    description: "New component tag"
    required: true

  kustomize-repo:
    description: kustomize repository
    required: true

  kustomize-ssh-key:
    description: kustomize RW access SSH key
    required: true

runs:
  using: composite
  steps:
    - name: Get Hawk Image Name
      id: get-hawk-image-name
      uses: hawk-ai-aml/github-actions/get-component-image@python
      with:
        profile: hawk
        component: ${{ inputs.component-name }}

    # https://hawkai.atlassian.net/browse/SRE-629
    # this relies that all nab overlays are called nab-dev
    # nicer way is to pass profile, than evaluating overlay
    - name: Get NAB Image Name
      id: get-nab-image-name
      if: inputs.component-overlay == 'nab-dev'
      uses: hawk-ai-aml/github-actions/get-component-image@python
      with:
        profile: nab
        component: ${{ inputs.component-name }}

    - name: Update kustomize Overlay
      shell: bash
      env:
        HAWK_IMAGE_NAME: ${{ steps.get-hawk-image-name.outputs.image-name }}
        NAB_IMAGE_NAME: ${{ steps.get-nab-image-name.outputs.image-name }}
        KUSTOMIZE_SSH_KEY_FILE: /home/builder/.ssh/id_kustomize_private_key
        KUSTOMIZE_SSH_KEY: ${{ inputs.kustomize-ssh-key }}
        KUSTOMIZE_PATH: ${{ fromJson(inputs.component-metadata).kustomize.path }}
        OVERLAY: ${{ inputs.component-overlay }}
      run: |
        # Prepare SSH
        mkdir -p $(dirname ${KUSTOMIZE_SSH_KEY_FILE})
        echo ${KUSTOMIZE_SSH_KEY} | base64 -d > ${KUSTOMIZE_SSH_KEY_FILE}
        chmod 600 ${KUSTOMIZE_SSH_KEY_FILE}
        export GIT_SSH_COMMAND="ssh -i ${KUSTOMIZE_SSH_KEY_FILE}"
        cat <<EOF >> ~/.ssh/known_hosts
        bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAubiN81eDcafrgMeLzaFPsw2kNvEcqTKl/VqLat/MaB33pZy0y3rJZtnqwR2qOOvbwKZYKiEO1O6VqNEBxKvJJelCq0dTXWT5pbO2gDXC6h6QDXCaHo6pOHGPUy+YBaGQRGuSusMEASYiWunYN0vCAI8QaXnWMXNMdFP3jHAJH0eDsoiGnLPBlBp4TNm6rYI74nMzgz3B9IikW4WVK+dc8KZJZWYjAuORU3jc1c/NPskD2ASinf8v3xnfXeukU0sJ5N6m5E8VLjObPEO+mN2t/FZTMZLiFqPWc/ALSqnMnnhwrNi2rbfg/rd/IpL8Le3pSBne8+seeFVBoGqzHM9yXw==
        github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
        EOF
        # End prepare SSH

        git clone ${{ inputs.kustomize-repo }} kustomize
        cd kustomize/${KUSTOMIZE_PATH}/overlays/${OVERLAY}

        # https://hawkai.atlassian.net/browse/SRE-629
        # this relies that all nab overlays are called nab-dev
        # nicer way is to pass profile, than evaluating overlay
        if [[ ${OVERLAY} == 'nab-dev' ]]; then
          kustomize edit set image ${HAWK_IMAGE_NAME}=${NAB_IMAGE_NAME}:${{ inputs.component-tag }}
        else
          kustomize edit set image ${HAWK_IMAGE_NAME}:${{ inputs.component-tag }}
        fi
        if ! git diff --quiet HEAD; then
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@hawk.ai"
          git add .
          git commit -m "AUTOMATIC COMMIT: Update ${KUSTOMIZE_PATH}/overlays/${OVERLAY} for ${{ inputs.component-name }} to ${{ env.HAWK_IMAGE_TAG }}"
          git push
        fi
