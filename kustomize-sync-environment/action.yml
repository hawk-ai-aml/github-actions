name: kustomize-sync-environment
description: Kustomize Sync Environments

inputs:
  environment:
    description: "Environments to sync"
    required: true

  directories:
    description: "List of directories to sync environments in (separated by a space)"
    required: true

  github-token:
    description: "Access token to GitHub users"
    required: true

runs:
  using: composite
  steps:

    - name: Checkout github-actions repo to load the script
      uses: actions/checkout@v4
      with:
        repository: hawk-ai-aml/github-actions
        ref: pe-5399
        path: github-actions

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: master
        token: ${{ inputs.github-token }}
        path: ${{ github.repository }}

    - name: Copy scripts
      run: |
        cp -R github-actions/kustomize-sync-environment/* ./${{ github.repository }}
        ls *
      shell: bash

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13.1'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install dotenv envsubst
      shell: bash

    - name: Process environments
      env:
        REPOSITORY: ${{ github.repository }}
      run: |
        set -e
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        
        cd ${REPOSITORY}
        echo -e "${GREEN}Processing environment files from properties/static..."
        echo -e "${GREEN}${REPOSITORY} structure:"
        ls *
        echo -e "${GREEN}End of structure"
        
        # Track if any changes were made
        CHANGES_MADE=false

        # Iterate through each file in properties/static directory
        env_name="${{ inputs.environment }}"
        env_file="properties/static/$env_name.env"
        if [ -f "$env_file" ]; then
          # Get the base filename (e.g., "sandbox.env")
          filename=$(basename "$env_file")

          echo ""
          echo "=========================================="
          echo "Processing environment: $env_name"
          echo "=========================================="

          # Make the output json into an env format and
          # concat the env file to working directory as .env
          output_file="properties/output/${env_name}.json"
          if [ -f "$output_file" ]; then
            jq -r '[paths(scalars) as $path | {"key": $path | join("."), "value": getpath($path)}] | from_entries | to_entries[] | "\(.key | gsub("[\\.-]"; "_"))=\"\(.value)\""' "$output_file" \
              | fgrep '_value' \
              |  sed -E 's/\_value//' \
              | cat - $env_file > .env
          else
            cp "$env_file" .env
          fi

          echo -e "${GREEN}Content of .env"
          cat .env
          echo ""
          echo -e "${GREEN}++++++++++++++++++++++++"
        
          for dir in ${{ inputs.directories }}; do
            if [ -d "$dir" ]; then
              echo "--- Processing platform directory ---"
              python3 copy_environment.py "$dir"
              echo "-------------------------------------"
              echo ""
            fi
          done

          echo ""
          echo "Completed processing for environment: $env_name"
        fi

        echo ""
        echo "=========================================="
        echo "All environments processed"
        echo "=========================================="

        # Save status for next step
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_ENV
        else
          echo "has_changes=false" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Create feature branch
      id: branch
      run: |
        BRANCH_NAME="sync-environments-$(date +%Y%m%d-%H%M%S)"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      shell: bash

    - name: Commit and push changes
      if: env.has_changes == 'true'
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        REPOSITORY: ${{ github.repository }}
        NEW_BRANCH: ${{ steps.branch.outputs.branch_name }}
      run: |
        cd ${REPOSITORY}

        git config --global user.name "GitHub Actions"
        git config --global user.email "github-actions@hawk.ai"
        
        echo "Changes detected, creating commit..."

        git checkout -b "$NEW_BRANCH"
        echo "Created branch: $NEW_BRANCH"
        
        git add -A
        git commit -m "Sync environments from kustomize-template

        Auto-generated commit from kustomize-template repository.

        Processed environments:
        $(ls -1 properties/static/ | sed 's/^/  - /' | sed 's/\.env$//')

        Commit: ${{ github.sha }}
        Triggered by: ${{ github.actor }}"

        echo "Pushing branch to remote..."
        REMOTE=${1:-origin}
        git push ${REMOTE} "${NEW_BRANCH}"
#        git push https://x-access-token:${GH_TOKEN}@github.com/${REPOSITORY} "${{ steps.branch.outputs.branch_name }}"
      shell: bash

    - name: Create Pull Request
      if: env.has_changes == 'true'
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        REPOSITORY: ${{ github.repository }}
        NEW_BRANCH: ${{ steps.branch.outputs.branch_name }}
      run: |
        cd ${REPOSITORY}
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        echo "Creating pull request..."
        gh pr create \
          --title "ðŸ”„ Sync environment ${{ inputs.environment }} from template" \
          --body "## Automated Environment Sync

        This PR was automatically generated by the sync workflow in the kustomize-template repository.

        ### Source Information
        - **Repository**: ${{ github.repository }}
        - **Commit**: ${{ github.sha }}
        - **Triggered by**: ${{ github.actor }}
        - **Workflow**: ${{ github.workflow }}

        ### Environments Processed
        $(ls -1 properties/static/ | sed 's/^/- /' | sed 's/\.env$//')

        ### Changes
        This PR includes updates to the following directories:
        - \`plattform/\` - Application services and configurations
        - \`kafka-management/\` - Kafka topic definitions

        All \`_template\` overlay directories have been expanded for the environments from \`properties/static/\`.

        ### Review Checklist
        - [ ] Verify kustomization.yaml paths are correct
        - [ ] Check image tags are appropriate for each environment
        - [ ] Validate environment-specific configurations
        - [ ] Ensure Kafka topic configurations are correct

        ---
        *This is an automated pull request. Review carefully before merging.*" \
          --base master \
          --head "$NEW_BRANCH"

        echo "âœ… Pull request created successfully!"
      shell: bash
